# Architecture

> Auto-generated by /map on 2026-02-25

## Overview

HealthGuard is a medical-grade mobile health monitoring system built on **Flutter (Android)** with a **Node.js + SQLite** backend. It reads real-time vitals from Health Connect (heart rate, blood pressure, glucose, sleep, steps, calories), provides AI-powered chat and coaching via Google Gemini, and features emergency spike alerts with GPS-based SMS notifications.

```
┌─────────────────────────────────────────────────────┐
│              Flutter Mobile App (Android)            │
│  ┌───────────┐ ┌───────────┐ ┌───────────────────┐  │
│  │ Dashboard  │ │ Chat AI   │ │ Coaching AI       │  │
│  │ (Vitals)   │ │ (Gemini)  │ │ (Gemini)          │  │
│  └─────┬─────┘ └─────┬─────┘ └────────┬──────────┘  │
│        │              │                │             │
│  ┌─────┴──────────────┴────────────────┴──────────┐  │
│  │           Services Layer                        │  │
│  │ HealthService │ ApiService │ ChatService        │  │
│  │ CoachingService │ SpikeAlertService             │  │
│  └──────┬────────────┬──────────────────┬─────────┘  │
│         │            │                  │            │
│  ┌──────┴──────┐ ┌───┴────────┐  ┌──────┴──────┐    │
│  │Health Connect│ │ Backend API│  │ Gemini API  │    │
│  │ (on-device) │ │ (REST)     │  │ (Google)    │    │
│  └─────────────┘ └───┬────────┘  └─────────────┘    │
└───────────────────────┼──────────────────────────────┘
                        │
┌───────────────────────┼──────────────────────────────┐
│              Node.js Backend (Express)               │
│  ┌───────────┐ ┌───────────┐ ┌───────────────────┐   │
│  │ /patient   │ │ /doctor   │ │ MedicalDB (ORM)   │  │
│  │ routes     │ │ routes    │ │ (generic CRUD)    │  │
│  └─────┬─────┘ └─────┬─────┘ └────────┬──────────┘   │
│        └──────────────┴────────────────┘              │
│                       │                               │
│              ┌────────┴────────┐                      │
│              │  SQLite DB       │                     │
│              │  medical_system  │                     │
│              └─────────────────┘                      │
└───────────────────────────────────────────────────────┘
```

## Components

### Flutter App (`healthguard_app/`)

#### Entry Point
- **Purpose:** App bootstrap with MaterialApp and named routing
- **Location:** `lib/main.dart`
- **Routes:** Role selection → Login/Signup → Dashboard (patient or doctor)

#### Features

| Feature | Location | Purpose |
|---------|----------|---------|
| Auth | `features/auth/` | Patient login/signup, Doctor login/signup, Role selection |
| Dashboard | `features/dashboard/` | Patient vitals dashboard, Doctor dashboard, Doctor patient vitals view |
| Chat Assistant | `features/chat_assistant/` | AI-powered health chat using Gemini |
| Coaching | `features/coaching/` | AI-generated personalized coaching plans |
| Vitals | `features/vitals/` | Detailed vitals viewing screen |
| Reminders | `features/reminders/` | Health reminders |
| Profile | `features/profile/` | User profile management |
| Book Appointment | `features/book_appointment/` | Appointment booking + doctor details |

#### Models

| Model | Location | Purpose |
|-------|----------|---------|
| UserVitals | `models/user_vitals.dart` | HR, BP, glucose, sleep, steps, calories, active minutes |
| VitalReading<T> | `models/vital_reading.dart` | Generic timestamped vital reading |
| BloodPressureReading | `models/blood_pressure_reading.dart` | Systolic/diastolic pair |
| ChatMessage | `models/chat_message.dart` | Chat message model |
| CoachingPlan | `models/coaching_plan.dart` | AI-generated coaching plan |
| RiskResult | `models/risk_result.dart` | Health risk assessment result |

#### Services

| Service | Location | Purpose |
|---------|----------|---------|
| HealthService | `services/health_service.dart` | Reads vitals from Health Connect API |
| ApiService | `services/api_service.dart` | REST calls to Node.js backend |
| ChatService | `services/chat_service.dart` | Multi-turn Gemini chat with vitals context |
| CoachingService | `services/coaching_service.dart` | Gemini-powered coaching plan generation |
| SpikeAlertService | `services/spike_alert_service.dart` | HR spike detection → SMS + GPS alerts |

### Backend (`backend/`)

- **Purpose:** REST API for patient/doctor management, vitals storage, appointments
- **Location:** `backend/`
- **Entry point:** `api.js` (Express on port 3000)

#### Routes

| Route | File | Endpoints |
|-------|------|-----------|
| `/patient` | `patient.js` | signup, login, set_vitals, get_vitals, book_appointment, update_profile, alert_spike |
| `/doctor` | `doctor.js` | register, login, get_info, get_patients, get_appointments, confirm_appointment |

#### Database (`db.js`)

| Table | Purpose |
|-------|---------|
| Doctor | doctor_id, pin, mobile, name, degree |
| Patient | patient_id, doctor_id, priority, name, username, password, emergency_contact, emergency_name, is_special_needs, doctor_mobile |
| Vitals | patient_id, heart_rate, bp, steps, calories, active_min, glucose |
| Appointments | appointment_id, time, doctor_id, patient_id, confirmed |

## Data Flow

1. **Vitals Collection:** HealthService → Health Connect API → UserVitals model
2. **Backend Sync:** ApiService → POST to `/patient/set_vitals` → SQLite
3. **AI Chat:** User message + vitals context → ChatService → Gemini API → response
4. **AI Coaching:** Vitals → CoachingService → Gemini API → structured coaching plan JSON
5. **Spike Alert:** HR > 100 BPM → GPS location → Backend log + SMS to emergency/doctor

## Integration Points

| Service | Type | Purpose |
|---------|------|---------|
| Google Gemini (gemini-1.5-flash) | REST API | AI chat assistant + coaching plan generation |
| Health Connect | Android SDK | Read heart rate, BP, glucose, sleep, steps, calories |
| Geolocator | Device API | GPS coordinates for spike alert location |
| SMS (url_launcher) | Device Intent | Emergency SMS with Google Maps link |
| Speech-to-Text | Device API | Voice input (speech_to_text package) |
| Flutter TTS | Device API | Text-to-speech output |

## Technical Debt

- [ ] Gemini API key is hardcoded in `config/ai_config.dart` (should use env vars)
- [ ] No CORS middleware in backend (caused issues in previous sessions)
- [ ] Passwords stored in plaintext (no hashing)
- [ ] No JWT/session management (auth state not persisted)
- [ ] `todayActiveMinutes` is hardcoded to 120 in `UserVitals`
- [ ] `latestSleep` is hardcoded to "5.34 hrs" in `UserVitals`
- [ ] SpO2 and Stress level are hardcoded (not available via Health Connect)
- [ ] `google_generative_ai` is in `dev_dependencies` instead of `dependencies`
- [ ] TODO: Edit profile screen (dashboard_screen.dart:793)
- [ ] TODO: Prescriptions screen (dashboard_screen.dart:804)
- [ ] No automated tests
- [ ] Backend uses GET for some mutation operations (register, set_vitals)

## Conventions

**Naming:** Feature-based folders (`features/auth/`, `features/dashboard/`), service files named `*_service.dart`, models in `models/`
**Structure:** Feature-first organization with shared services layer
**State:** StatefulWidget with local state (no state management library)
**Testing:** No test files present
**Routing:** Named routes via MaterialApp `routes` map
